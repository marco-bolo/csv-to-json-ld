name: Build JSON-LD
on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - main
  #pull_request:
  workflow_run:
    workflows: ["Sync Google Sheet to CSV"]
    types:
      - completed

permissions:
  contents: write
  issues: write  # Added for creating issues

jobs:
  validate-csvws-build-jsonld:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Fix timestamps - necessary for differential build
      - name: restore timestamps
        uses: chetan/git-restore-mtime-action@v2
      
      - name: Load previous outputs from cache for differential build
        uses: actions/cache@v4
        with:
          path: out/
          key: ${{ github.ref }}-8
      
      - name: Initialise make
        run: make init
      
      # NEW: Sync UUID Registry BEFORE validation and build
      - name: Sync UUID Registry
        id: sync_uuids
        run: |
          python3 scripts/sync_uuids.py --csv-pattern "data/*.csv" --registry-path "config/uuid_mapping.json" --id-column "MBO Permanent Identifier*"
        continue-on-error: true  # Don't fail if missing IDs detected
      
      # NEW: Generate missing IDs report
      - name: Generate Missing IDs Report
        if: steps.sync_uuids.outputs.has_missing == 'true'
        run: python3 scripts/generate_missing_ids_report.py

      # NEW: Build issue body from boilerplate + dynamic report
      - name: Build Issue Body
        if: steps.sync_uuids.outputs.has_missing == 'true'
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          cat <<EOF > issue_body.md
          ## Missing Identifier Report
          **Generated:** ${TIMESTAMP}
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          The following identifiers exist in the UUID registry but were **not found** in the current CSV files. See the [UUID Registry](/${{ github.repository }}/blob/main/config/uuid_mapping.json) for reference.

          ### Action Required
          - **Typo fix**: Update the registry value to the corrected identifier
          - **Renamed**: Update the registry value to the new identifier
          - **Deleted**: Remove the entry from the registry
          - **Temporary**: No action needed, but document why

          ---

          EOF
          cat missing_ids_report.md >> issue_body.md

      # NEW: Create or update GitHub issue for missing IDs
      - name: Create/Update Missing IDs Issue
        if: steps.sync_uuids.outputs.has_missing == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "⚠️ Missing Identifiers Detected - ${{ github.run_id }}"
          content-filepath: issue_body.md
          labels: |
            uuid-sync
            needs-review
          assignees: ${{ github.actor }}
      
      # NEW: Commit registry updates (new UUIDs only)
      - name: Commit UUID Registry Updates
        if: steps.sync_uuids.outputs.has_new == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add config/uuid_mapping.json
          git add id_sync_report.json
          
          git commit -m "Add UUIDs for ${{ steps.sync_uuids.outputs.new_count }} new identifier(s)"
          git push
      
      # Replace semantic IDs with UUIDs in CSVs
      - name: Replace IDs with UUIDs in CSVs
        run: bash scripts/replace_ids_with_uuids.sh data config/uuid_mapping.json
        
      # Continue with existing validation and build steps
      - name: Validate CSV-Ws
        run: make validate
      
      - name: Validate SHACL Constraints
        run: make shacl-report
      
      - name: Build JSON-LD
        # The JSON-LD build now uses UUIDs from the registry
        run: make jsonld -j 2
      
      - name: Commit JSON-LD outputs for MkDocs
        if: github.ref == 'refs/heads/main'
        run: |
          # Remove existing directory to clear any vestigial files
          rm -rf remote/models/schema-jsonld
          
          # Create fresh directory
          mkdir -p remote/models/schema-jsonld
          
          # Copy JSON-LD files to MkDocs source directory
          cp out/*.json remote/models/schema-jsonld/
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all changes including deletions
          git add -A remote/models/schema-jsonld/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update JSON-LD outputs"
            git push
          fi
